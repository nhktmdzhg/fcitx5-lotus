name: Build & Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-deb:
    name: DEB [${{ matrix.codename }}]
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: debian:12
            codename: bookworm
            parallel: 2
          # - distro: debian:13
          #   codename: trixie
          #   parallel: 4
          # - distro: debian:testing
          #   codename: testing
          #   parallel: 4
          # - distro: debian:unstable
          #   codename: sid
          #   parallel: 4
          # - distro: ubuntu:22.04
          #   codename: jammy
          #   parallel: 1
          # - distro: ubuntu:24.04
          #   codename: noble
          #   parallel: 2
          # - distro: ubuntu:25.04
          #   codename: plucky
          #   parallel: 4
          # - distro: ubuntu:25.10
          #   codename: questing
          #   parallel: 4

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare debian directory
        run: cp -r packaging/debian debian

      - name: Build DEB
        uses: jtdor/build-deb-action@v1
        env:
          DEB_BUILD_OPTIONS: parallel=${{ matrix.parallel }}
        with:
          docker-image: ${{ matrix.distro }}
          buildpackage-opts: --build=binary --no-sign

      - name: Rename DEB artifacts
        run: |
          for f in debian/artifacts/*.deb; do
            base=$(basename "$f" .deb)
            sudo mv "$f" "debian/artifacts/${base}_${{ matrix.codename }}.deb"
          done

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.codename }}
          path: debian/artifacts/*.deb
          retention-days: 1

  build-rpm-fedora:
    name: RPM [fedora-${{ matrix.releasever }}]
    strategy:
      fail-fast: false
      matrix:
        include:
          # - distro: fedora:42
          #   releasever: 42
          # - distro: fedora:43
          #   releasever: 43
          - distro: fedora:rawhide
            releasever: rawhide

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Fedora RPM
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ matrix.distro }}
          options: -v ${{ github.workspace }}:/work
          run: |
            dnf install -y \
              rpm-build rpmdevtools cmake extra-cmake-modules \
              gcc-c++ glibc-devel fcitx5-devel libinput-devel \
              systemd-rpm-macros libudev-devel libX11-devel \
              golang libgudev-devel gettext-devel
            rpmdev-setuptree
            cp /work/packaging/rpm/fedora/fcitx5-lotus.spec ~/rpmbuild/SPECS/
            mkdir -p ~/rpmbuild/SOURCES
            cd /work
            VERSION=$(grep '^Version:' packaging/rpm/fedora/fcitx5-lotus.spec | awk '{print $2}')
            tar --exclude='.git' \
                --exclude='packaging' \
                --transform "s|^\.|fcitx5-lotus-${VERSION}|" \
                -czf ~/rpmbuild/SOURCES/fcitx5-lotus-${VERSION}.tar.gz .
            rpmbuild -bb ~/rpmbuild/SPECS/fcitx5-lotus.spec
            mkdir -p /work/output
            for rpm in ~/rpmbuild/RPMS/**/*.rpm; do
              base=$(basename "$rpm" .rpm)
              mv "$rpm" "/work/output/${base}.${{ matrix.releasever }}.rpm"
            done

      - name: Sign RPM packages
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          sudo chmod -R 777 output/
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

          mkdir -p ~/.gnupg
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye || true

          KEYID=$(gpg --list-secret-keys --with-colons | grep '^sec' | head -1 | cut -d: -f5)

          cat > ~/.rpmmacros << EOF
          %_gpg_name ${KEYID}
          %__gpg_sign_cmd %{__gpg} gpg \
            --no-verbose --no-armor --batch \
            --pinentry-mode loopback \
            --passphrase-fd 3 \
            -u "%{_gpg_name}" \
            -sbo %{__signature_filename} \
            %{__plaintext_filename}
          EOF

          for rpm in output/*.rpm; do
            rpmsign --addsign "$rpm" 3< <(echo "$GPG_PASSPHRASE")
          done

          gpg --batch --yes --delete-secret-and-public-key "$KEYID" || true

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-fedora-${{ matrix.releasever }}
          path: output/*.rpm
          retention-days: 1

  build-rpm-opensuse:
    name: RPM [opensuse-${{ matrix.releasever }}]
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: opensuse/tumbleweed
            releasever: tumbleweed

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build openSUSE RPM
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ matrix.distro }}
          options: -v ${{ github.workspace }}:/work
          run: |
            zypper install -y \
              rpm-build rpmdevtools cmake extra-cmake-modules \
              gcc-c++ glibc-devel fcitx5-devel libinput-devel \
              systemd-rpm-macros libudev-devel libX11-devel \
              go libgudev-1_0-devel sysuser-tools
            rpmdev-setuptree
            cp /work/packaging/rpm/opensuse/fcitx5-lotus.spec ~/rpmbuild/SPECS/
            mkdir -p ~/rpmbuild/SOURCES
            cd /work
            VERSION=$(grep '^Version:' packaging/rpm/opensuse/fcitx5-lotus.spec | awk '{print $2}')
            tar --exclude='.git' \
                --exclude='packaging' \
                --transform "s|^\.|fcitx5-lotus-${VERSION}|" \
                -czf ~/rpmbuild/SOURCES/fcitx5-lotus-${VERSION}.tar.gz .
            rpmbuild -bb ~/rpmbuild/SPECS/fcitx5-lotus.spec
            mkdir -p /work/output
            for rpm in ~/rpmbuild/RPMS/**/*.rpm; do
              base=$(basename "$rpm" .rpm)
              mv "$rpm" "/work/output/${base}.${{ matrix.releasever }}.rpm"
            done

      - name: Sign RPM packages
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          sudo chmod -R 777 output/
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

          mkdir -p ~/.gnupg
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye || true

          KEYID=$(gpg --list-secret-keys --with-colons | grep '^sec' | head -1 | cut -d: -f5)

          cat > ~/.rpmmacros << EOF
          %_gpg_name ${KEYID}
          %__gpg_sign_cmd %{__gpg} gpg \
            --no-verbose --no-armor --batch \
            --pinentry-mode loopback \
            --passphrase-fd 3 \
            -u "%{_gpg_name}" \
            -sbo %{__signature_filename} \
            %{__plaintext_filename}
          EOF

          for rpm in output/*.rpm; do
            rpmsign --addsign "$rpm" 3< <(echo "$GPG_PASSPHRASE")
          done

          gpg --batch --yes --delete-secret-and-public-key "$KEYID" || true

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-opensuse-${{ matrix.releasever }}
          path: output/*.rpm
          retention-days: 1

  release:
    name: Create GitHub Release
    needs: [build-deb, build-rpm-fedora, build-rpm-opensuse]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.deb
            artifacts/**/*.rpm
          generate_release_notes: true
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    name: Deploy to Cloudflare Pages
    needs: [release]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y reprepro createrepo-c gnupg2

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

            - name: Import GPG key + trust
              env:
                GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
              run: |
                mkdir -p ~/.gnupg
                chmod 700 ~/.gnupg

                echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
                echo "pinentry-mode loopback"  > ~/.gnupg/gpg.conf

                gpg --batch --import <<< "${{ secrets.GPG_PRIVATE_KEY }}"

                FINGERPRINT=$(gpg --list-secret-keys --with-colons \
                  | grep '^fpr' | head -1 | cut -d: -f10)
                echo "${FINGERPRINT}:6:" | gpg --import-ownertrust

                gpg-connect-agent reloadagent /bye

                KEYGRIP=$(gpg --list-secret-keys --with-keygrip --with-colons \
                  | grep '^grp' | head -1 | cut -d: -f10)

                echo "$GPG_PASSPHRASE" \
                  | /usr/lib/gnupg2/gpg-preset-passphrase --preset "$KEYGRIP"

                echo "FINGERPRINT=${FINGERPRINT}" >> $GITHUB_ENV

      - name: Create APT repo structure
        run: |
          mkdir -p repo/apt/conf
          cat > repo/apt/conf/distributions << EOF
          Codename: bookworm
          Suite: stable
          Components: main
          Architectures: amd64 arm64
          SignWith: ${{ env.FINGERPRINT }}

          Codename: trixie
          Suite: stable
          Components: main
          Architectures: amd64 arm64
          SignWith: ${{ env.FINGERPRINT }}

          Codename: testing
          Suite: stable
          Components: main
          Architectures: amd64 arm64
          SignWith: ${{ env.FINGERPRINT }}

          Codename: sid
          Suite: unstable
          Components: main
          Architectures: amd64 arm64
          SignWith: ${{ env.FINGERPRINT }}

          Codename: jammy
          Suite: stable
          Components: main
          Architectures: amd64 arm64
          SignWith: ${{ env.FINGERPRINT }}

          Codename: noble
          Suite: stable
          Components: main
          Architectures: amd64 arm64
          SignWith: ${{ env.FINGERPRINT }}

          Codename: plucky
          Suite: stable
          Components: main
          Architectures: amd64 arm64
          SignWith: ${{ env.FINGERPRINT }}

          Codename: questing
          Suite: stable
          Components: main
          Architectures: amd64 arm64
          SignWith: ${{ env.FINGERPRINT }}
          EOF

      - name: Populate APT repo
        env:
          GNUPGHOME: /home/runner/.gnupg
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PASSPHRASE" | gpg --batch \
            --pinentry-mode loopback \
            --passphrase-fd 0 \
            -u "$FINGERPRINT" \
            --sign /dev/null -o /dev/null 2>/dev/null || true

          for codename in bookworm trixie testing sid jammy noble plucky questing; do
            for deb in artifacts/deb-${codename}/*.deb; do
              [ -f "$deb" ] || continue
              echo "Adding $deb â†’ $codename"
              reprepro \
                --gnupghome "$GNUPGHOME" \
                -b repo/apt \
                includedeb "$codename" "$deb"
            done
          done

      - name: Create Fedora RPM repos
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          for releasever in 42 43 rawhide; do
            dir="repo/rpm/fedora/${releasever}/x86_64"
            mkdir -p "$dir"
            for rpm in artifacts/rpm-fedora-${releasever}/*.rpm; do
              [ -f "$rpm" ] || continue
              [[ "$rpm" == *debug* ]] && continue
              cp "$rpm" "$dir/"
            done
            [ "$(ls -A $dir)" ] || continue
            createrepo_c "$dir"
            echo "$GPG_PASSPHRASE" | gpg --batch --yes \
              --pinentry-mode loopback \
              --passphrase-fd 0 \
              --detach-sign --armor \
              "$dir/repodata/repomd.xml"
          done

      - name: Create openSUSE RPM repo
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          dir="repo/rpm/opensuse/tumbleweed/x86_64"
          mkdir -p "$dir"
          for rpm in artifacts/rpm-opensuse-tumbleweed/*.rpm; do
            [ -f "$rpm" ] || continue
            [[ "$rpm" == *debug* ]] && continue
            cp "$rpm" "$dir/"
          done
          [ "$(ls -A $dir)" ] || { echo "No RPMs found"; exit 0; }
          createrepo_c "$dir"
          echo "$GPG_PASSPHRASE" | gpg --batch --yes \
            --pinentry-mode loopback \
            --passphrase-fd 0 \
            --detach-sign --armor \
            "$dir/repodata/repomd.xml"

      - name: Copy public key
        run: cp packaging/pubkey.gpg repo/pubkey.gpg

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy repo --project-name=fcitx5-lotus --branch=main --commit-dirty=true

      - name: Cleanup GPG
        if: always()
        run: |
          gpg --batch --yes \
            --delete-secret-and-public-key "${{ env.FINGERPRINT }}" || true
